///************************************************
/// Generated by: Anhpt
/// Date: 17/08/2015 03:24:31
/// Goal: Create User Service Class for HT_NGUOI_SU_DUNG
///************************************************
/// <summary>
/// Create User Service Class for HT_NGUOI_SU_DUNG
/// </summary>

using System;
using IPCOREDS;
using IP.Core.IPCommon;
using IP.Core.IPUserService;
using System.Data.SqlClient;
using System.Data;
using System.Collections.Generic;
using IPCOREUS;
using TOSApp.App_Code;



namespace TOSApp
{

    public class us_user
    {
        private const string c_TableName = "HT_NGUOI_SU_DUNG";
        #region Public Properties
        public static decimal dcID;
        public static decimal dcCHI_NHANH;
        public static string strTEN_TRUY_CAP;
        public string strTEN;
        public static string strMAT_KHAU;
        public static string strEMAIL;
        public static decimal dcIDNhom;
        public static string ipphone;
        public static string TD_tu_choi;
        public static string GetMD5(string txt)
        {
            string str = "";
            Byte[] buffer = System.Text.Encoding.UTF8.GetBytes(txt);
            System.Security.Cryptography.MD5CryptoServiceProvider md5 = new System.Security.Cryptography.MD5CryptoServiceProvider();
            buffer = md5.ComputeHash(buffer);
            foreach (byte tmp in buffer)
            {
                str += tmp.ToString("x2");
            }
            return str;
        }

        public static bool trang_thai_dang_nhap;

        public static void gui_mail_thong_bao_xu_ly_xong_don_hang(US_V_GD_DAT_HANG_GD_LOG_DAT_HANG v_us_log, decimal v_id_nguoi_xu_ly)
        {
            US_DUNG_CHUNG v_us = new US_DUNG_CHUNG();
            DataSet v_ds = new DataSet();
            v_ds.Tables.Add(new DataTable());
            v_us.FillDatasetWithQuery(v_ds, "select * from dm_mau_email where id = 16");
            string TIEU_DE = v_ds.Tables[0].Rows[0]["TIEU_DE_MAIL"].ToString();
            string NOI_DUNG = v_ds.Tables[0].Rows[0]["NOI_DUNG_EMAIL"].ToString();
            string GUI_CC = v_ds.Tables[0].Rows[0]["GUI_CC"].ToString();

            TIEU_DE = TIEU_DE.Replace("MA_DON_HANG", v_us_log.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("MA_DON_HANG", v_us_log.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_NHAN_VIEN", v_us_log.strHO_TEN_USER_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_DON_VI", v_us_log.strMA_DON_VI);
            NOI_DUNG = NOI_DUNG.Replace("USER_DIEN_THOAI", v_us_log.strDIEN_THOAI);
            NOI_DUNG = NOI_DUNG.Replace("USER_THOI_GIAN_DAT_HANG", v_us_log.datTHOI_GIAN_TAO.ToString());
            NOI_DUNG = NOI_DUNG.Replace("LOAI_DICH_VU_HO_TRO", v_us_log.strTEN_NHOM_DICH_VU_YEU_CAU);
            NOI_DUNG = NOI_DUNG.Replace("YEU_CAU_CU_THE", v_us_log.strNOI_DUNG_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_HOAN_THANH_THUC_TE", "Chưa Có");
            NOI_DUNG = NOI_DUNG.Replace("LICH_SU_TRAO_DOI", "Hoàn thành đơn hàng chờ TM nghiệm thu");
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_MONG_MUON_SUA_XONG", v_us_log.datTHOI_DIEM_CAN_HOAN_THANH + "hoặc thời gian hoàn thành là:" + v_us_log.datTHOI_GIAN_HOAN_THANH);
            NOI_DUNG = NOI_DUNG.Replace("PHAN_HOI_CUA_DVMC", v_us_log.strPHAN_HOI_TU_DVMC);
            IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_nguoi_xu_ly = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_id_nguoi_xu_ly);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_XU_LY_DON_HANG", v_us_nguoi_xu_ly.strTEN_TRUY_CAP);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_NHAN_DAT_HANG", v_us_log.strNGUOI_TAO_THAO_TAC);
            string to_cc = "";
            US_DUNG_CHUNG v_us_tm = new US_DUNG_CHUNG();
            DataSet v_ds_tm = new DataSet();
            v_ds_tm.Tables.Add(new DataTable());
            v_us_tm.FillDatasetWithQuery(v_ds_tm, "SELECT HT_NGUOI_SU_DUNG.ID,HT_NGUOI_SU_DUNG.EMAIL FROM HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH,HT_NGUOI_SU_DUNG WHERE HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH.ID_NGUOI_SU_DUNG = HT_NGUOI_SU_DUNG.ID AND HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH.ID_NHOM = 4");
            for (int i = 0; i < v_ds_tm.Tables[0].Rows.Count; i++)
			{
			   if(i==0)
                    to_cc = v_ds_tm.Tables[0].Rows[i]["EMAIL"].ToString();
               else
                    GUI_CC+= "," + v_ds_tm.Tables[0].Rows[i]["EMAIL"].ToString();
            }
            
            try
            {
                string user_email = "dvmc@topica.edu.vn";
                string password = "topica123";
                IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_fo = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_us_log.dcID_NGUOI_TAO);
                GUI_CC += "," + v_us_fo.strEMAIL;
                HelpUtils.send_mail("Dịch Vụ Một Cửa<Hoàn tất xử lý>", user_email, password, to_cc, GUI_CC, TIEU_DE, NOI_DUNG);
            }

            catch (Exception v_e)
            {
                CSystemLog_100.ExceptionHandle(v_e);
            }
        }

        public static void gui_mail_thong_bao_cap_nhat_xu_ly_don_hang(US_V_GD_DAT_HANG_GD_LOG_DAT_HANG v_us_log, decimal v_id_nguoi_xu_ly)
        {
            US_DUNG_CHUNG v_us = new US_DUNG_CHUNG();
            DataSet v_ds = new DataSet();
            v_ds.Tables.Add(new DataTable());
            v_us.FillDatasetWithQuery(v_ds, "select * from dm_mau_email where id = 16");
            string TIEU_DE = v_ds.Tables[0].Rows[0]["TIEU_DE_MAIL"].ToString();
            string NOI_DUNG = v_ds.Tables[0].Rows[0]["NOI_DUNG_EMAIL"].ToString();
            string GUI_CC = v_ds.Tables[0].Rows[0]["GUI_CC"].ToString();
            TIEU_DE = TIEU_DE.Replace("MA_DON_HANG", v_us_log.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("NOI_DUNG_CAP_NHAT", v_us_log.strGHI_CHU);
            NOI_DUNG = NOI_DUNG.Replace("MA_DON_HANG", v_us_log.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_NHAN_VIEN", v_us_log.strHO_TEN_USER_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_DON_VI", v_us_log.strMA_DON_VI);
            NOI_DUNG = NOI_DUNG.Replace("USER_DIEN_THOAI", v_us_log.strDIEN_THOAI);
            NOI_DUNG = NOI_DUNG.Replace("USER_THOI_GIAN_DAT_HANG", v_us_log.datTHOI_GIAN_TAO.ToString());
            NOI_DUNG = NOI_DUNG.Replace("LOAI_DICH_VU_HO_TRO", v_us_log.strTEN_NHOM_DICH_VU_YEU_CAU);
            NOI_DUNG = NOI_DUNG.Replace("YEU_CAU_CU_THE", v_us_log.strNOI_DUNG_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_HOAN_THANH_THUC_TE", "Chưa Có");
            NOI_DUNG = NOI_DUNG.Replace("LICH_SU_TRAO_DOI", "Hoàn thành đơn hàng chờ TM nghiệm thu");
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_MONG_MUON_SUA_XONG", v_us_log.datTHOI_DIEM_CAN_HOAN_THANH + "hoặc thời gian hoàn thành là:" + v_us_log.datTHOI_GIAN_HOAN_THANH);
            NOI_DUNG = NOI_DUNG.Replace("PHAN_HOI_CUA_DVMC", v_us_log.strPHAN_HOI_TU_DVMC);
            IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_nguoi_xu_ly = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_id_nguoi_xu_ly);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_XU_LY_DON_HANG", v_us_nguoi_xu_ly.strTEN_TRUY_CAP);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_NHAN_DAT_HANG", v_us_log.strNGUOI_TAO_THAO_TAC);
            string to_cc = "";
            US_DUNG_CHUNG v_us_tm = new US_DUNG_CHUNG();
            DataSet v_ds_tm = new DataSet();
            v_ds_tm.Tables.Add(new DataTable());
            v_us_tm.FillDatasetWithQuery(v_ds_tm, "SELECT HT_NGUOI_SU_DUNG.ID,HT_NGUOI_SU_DUNG.EMAIL FROM HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH,HT_NGUOI_SU_DUNG WHERE HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH.ID_NGUOI_SU_DUNG = HT_NGUOI_SU_DUNG.ID AND HT_NGUOI_SU_DUNG_NHOM_CHI_NHANH.ID_NHOM = 4");
            for (int i = 0; i < v_ds_tm.Tables[0].Rows.Count; i++)
            {
                if (i == 0)
                    to_cc = v_ds_tm.Tables[0].Rows[i]["EMAIL"].ToString();
                else
                    GUI_CC += "," + v_ds_tm.Tables[0].Rows[i]["EMAIL"].ToString();
            }

            try
            {
                string user_email = "dvmc@topica.edu.vn";
                string password = "topica123";
                IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_fo = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_us_log.dcID_NGUOI_TAO);
                GUI_CC += "," + v_us_fo.strEMAIL;
                HelpUtils.send_mail("Dịch Vụ Một Cửa<Hoàn tất xử lý>", user_email, password, to_cc, GUI_CC, TIEU_DE, NOI_DUNG);
            }

            catch (Exception v_e)
            {
                CSystemLog_100.ExceptionHandle(v_e);
            }
        }
        public static void gui_mail_thong_bao_chuyen_don_hang(US_V_GD_DAT_HANG_GD_LOG_DAT_HANG v_us_log_gd, decimal v_id_nguoi_xu_ly, decimal v_id_nguoi_nhan)
        {
            US_DUNG_CHUNG v_us = new US_DUNG_CHUNG();
            DataSet v_ds = new DataSet();
            v_ds.Tables.Add(new DataTable());
            v_us.FillDatasetWithQuery(v_ds, "select * from dm_mau_email where id =10");
            string TIEU_DE = v_ds.Tables[0].Rows[0]["TIEU_DE_MAIL"].ToString();
            string NOI_DUNG = v_ds.Tables[0].Rows[0]["NOI_DUNG_EMAIL"].ToString();
            string GUI_CC = v_ds.Tables[0].Rows[0]["GUI_CC"].ToString();

            TIEU_DE = TIEU_DE.Replace("MA_DON_HANG", v_us_log_gd.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("MA_DON_HANG", v_us_log_gd.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_NHAN_VIEN", v_us_log_gd.strHO_TEN_USER_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_DON_VI", v_us_log_gd.strMA_DON_VI);
            NOI_DUNG = NOI_DUNG.Replace("USER_DIEN_THOAI", v_us_log_gd.strDIEN_THOAI);
            NOI_DUNG = NOI_DUNG.Replace("USER_THOI_GIAN_DAT_HANG", v_us_log_gd.datTHOI_GIAN_TAO.ToString());
            NOI_DUNG = NOI_DUNG.Replace("LOAI_DICH_VU_HO_TRO", v_us_log_gd.strTEN_NHOM_DICH_VU_YEU_CAU);
            NOI_DUNG = NOI_DUNG.Replace("YEU_CAU_CU_THE", v_us_log_gd.strNOI_DUNG_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_HOAN_THANH_THUC_TE", "chưa có");
            NOI_DUNG = NOI_DUNG.Replace("LICH_SU_TRAO_DOI", "Vừa tiếp nhận.");
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_MONG_MUON_SUA_XONG", v_us_log_gd.datTHOI_DIEM_CAN_HOAN_THANH + "hoặc thời gian hoàn thành là:" + v_us_log_gd.datTHOI_GIAN_HOAN_THANH);
            NOI_DUNG = NOI_DUNG.Replace("PHAN_HOI_CUA_DVMC", v_us_log_gd.strPHAN_HOI_TU_DVMC);
            IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_nguoi_xu_ly = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_id_nguoi_xu_ly);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_XU_LY_DON_HANG", v_us_nguoi_xu_ly.strTEN_TRUY_CAP);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_NHAN_DAT_HANG", v_us_log_gd.strNGUOI_TAO_THAO_TAC);
            IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_nguoi_nhan = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_id_nguoi_nhan);
            string to_cc = v_us_nguoi_nhan.strEMAIL;
            try
            {
                string user_email = "dvmc@topica.edu.vn";
                string password = "topica123";
                IPCOREUS.US_HT_NGUOI_SU_DUNG v_us_fo = new IPCOREUS.US_HT_NGUOI_SU_DUNG(v_us_log_gd.dcID_NGUOI_TAO);
                GUI_CC += "," + v_us_fo.strEMAIL;
                HelpUtils.send_mail("Dịch Vụ Một Cửa", user_email, password, to_cc, GUI_CC, TIEU_DE, NOI_DUNG);
            }
            catch (Exception v_e)
            {
                CSystemLog_100.ExceptionHandle(v_e);
            }
        }
        public static void gui_mail_huy_don_hang(US_V_GD_DAT_HANG v_us_log_gd, string v_ly_do)
        {
            US_DUNG_CHUNG v_us = new US_DUNG_CHUNG();
            DataSet v_ds = new DataSet();
            v_ds.Tables.Add(new DataTable());
            v_us.FillDatasetWithQuery(v_ds, "select * from dm_mau_email where id =7");
            string TIEU_DE = v_ds.Tables[0].Rows[0]["TIEU_DE_MAIL"].ToString();
            string NOI_DUNG = v_ds.Tables[0].Rows[0]["NOI_DUNG_EMAIL"].ToString();
            string GUI_CC = v_ds.Tables[0].Rows[0]["GUI_CC"].ToString();
            TIEU_DE = TIEU_DE.Replace("MA_DON_HANG", v_us_log_gd.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("MA_DON_HANG", v_us_log_gd.strMA_DON_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_NHAN_VIEN", v_us_log_gd.strHO_TEN_USER_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("USER_DON_VI", v_us_log_gd.strMA_DON_VI);
            NOI_DUNG = NOI_DUNG.Replace("USER_DIEN_THOAI", v_us_log_gd.strDIEN_THOAI);
            NOI_DUNG = NOI_DUNG.Replace("USER_THOI_GIAN_DAT_HANG", v_us_log_gd.datTHOI_GIAN_TAO.ToString());
            NOI_DUNG = NOI_DUNG.Replace("LOAI_DICH_VU_HO_TRO", v_us_log_gd.strTEN_YEU_CAU);
            NOI_DUNG = NOI_DUNG.Replace("YEU_CAU_CU_THE", v_us_log_gd.strNOI_DUNG_DAT_HANG);
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_HOAN_THANH_THUC_TE", "chưa có");
            NOI_DUNG = NOI_DUNG.Replace("LICH_SU_TRAO_DOI", "Vừa tiếp nhận.");
            NOI_DUNG = NOI_DUNG.Replace("THOI_GIAN_MONG_MUON_SUA_XONG", v_us_log_gd.datTHOI_DIEM_CAN_HOAN_THANH + " hoặc thời gian hoàn thành là:" + v_us_log_gd.datTHOI_GIAN_HOAN_THANH);
            NOI_DUNG = NOI_DUNG.Replace("PHAN_HOI_CUA_DVMC", "Đơn hàng của bạn đã bị hủy với lý do: " + v_ly_do );
            string nguoi_xu_ly = "";
            US_DUNG_CHUNG v_us_3 = new US_DUNG_CHUNG();
            DataSet v_ds_3 = new DataSet();
            v_ds_3.Tables.Add(new DataTable());
            v_us_3.FillDatasetWithQuery(v_ds_3, "select * from V_GD_DAT_HANG_GD_LOG_DAT_HANG where ten_nguoi_tao_thao_tac_log is not null and THAO_TAC_HET_HAN_YN ='N' and ID_DON_HANG=" + v_us_log_gd.dcID);
            for (int i = 0; i < v_ds_3.Tables[0].Rows.Count; i++)
            {
                nguoi_xu_ly += "," + v_ds_3.Tables[0].Rows[i]["TEN_NGUOI_TAO_THAO_TAC_LOG"].ToString();
            }

            NOI_DUNG = NOI_DUNG.Replace("NGUOI_XU_LY_DON_HANG", nguoi_xu_ly);
            NOI_DUNG = NOI_DUNG.Replace("NGUOI_NHAN_DAT_HANG", v_us_log_gd.strNGUOI_TAO);
            US_DUNG_CHUNG v_us_kh = new US_DUNG_CHUNG();
            DataSet v_ds_kh = new DataSet();
            v_ds_kh.Tables.Add(new DataTable());
            v_us_kh.FillDatasetWithQuery(v_ds_kh, "select * from dm_khach_hang where id=" + v_us_log_gd.dcID_USER_NV_DAT_HANG);
            string to_cc = "";
            to_cc = v_ds_kh.Tables[0].Rows[0]["EMAIL"].ToString();

            try
            {
                string user_email = "dvmc@topica.edu.vn";
                string password = "topica123";
                HelpUtils.send_mail("Dịch Vụ Một Cửa<Thông báo hủy đơn hàng>", user_email, password, to_cc, GUI_CC, TIEU_DE, NOI_DUNG);

            }

            catch (Exception v_e)
            {
                CSystemLog_100.ExceptionHandle(v_e);
            }
        }



        #endregion



    }
}
